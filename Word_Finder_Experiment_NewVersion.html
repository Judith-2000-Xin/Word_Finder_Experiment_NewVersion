<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Find the Letter</title>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      background: #f4f4f4;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .content {
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(45, 1fr);
      max-width: 95vw;
      margin: auto;
      gap: 0.3vw;
      font-size: calc(0.7vw + 0.7vh);
      line-height: 1.8;
      word-break: break-word;
    }
    .cell {
      cursor: pointer;
      user-select: none;
    }
    .cell.selected {
      background: yellow;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 2em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .hidden {
      display: none;
    }
    #exportBtn {
      margin: 1em;
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="content">
    <h2>üîç Find the letter: <span id="targetLetter">A</span></h2>
    <button id="exportBtn">Export CSV</button>
    <div class="grid" id="grid"></div>
  </div>
  <div id="overlay" class="overlay hidden">Next page in 3 seconds...</div>

  <script>
    const TOTAL_PAGES = 26;
    const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const LETTERS_SET = new Set(LETTERS);
    const GRID_WIDTH = 45;
    const GRID_HEIGHT = 25;
    const TIME_LIMIT = 90; // seconds

    const usedLetters = new Set();
    const dataRecords = [];

    let currentLetter = '';
    let currentContent = '';
    let correctCount = 0;
    let clickCount = 0;
    let startTime = 0;
    let pageIndex = 0;

    const grid = document.getElementById('grid');
    const overlay = document.getElementById('overlay');
    const targetLetterDisplay = document.getElementById('targetLetter');

    function getRandomLetter() {
      const remaining = LETTERS.filter(l => !usedLetters.has(l));
      return remaining[Math.floor(Math.random() * remaining.length)];
    }

    function generateArticle(letter, count = 8 + Math.floor(Math.random() * 9)) {
      let text = '';
      const totalCells = GRID_WIDTH * GRID_HEIGHT;
      const positions = new Set();

      while (positions.size < count) {
        positions.add(Math.floor(Math.random() * totalCells));
      }

      for (let i = 0; i < totalCells; i++) {
        if (positions.has(i)) {
          text += letter;
        } else {
          let randChar;
          do {
            randChar = Math.random() < 0.5
              ? String.fromCharCode(65 + Math.floor(Math.random() * 26))
              : String.fromCharCode(48 + Math.floor(Math.random() * 10));
          } while (randChar === letter);
          text += randChar;
        }
      }
      return text;
    }

    function renderGrid(content) {
      grid.innerHTML = '';
      [...content].forEach((ch, i) => {
        const div = document.createElement('div');
        div.textContent = ch;
        div.className = 'cell';
        div.addEventListener('click', () => {
          div.classList.toggle('selected');
        });
        grid.appendChild(div);
      });
    }

    function nextPage() {
      if (pageIndex >= TOTAL_PAGES) {
        alert('All done! Export or refresh to restart.');
        return;
      }
      if (pageIndex > 0) {
        const elapsed = Math.round(performance.now() / 1000 - startTime);
        const correct = [...document.querySelectorAll('.cell')].filter(cell => cell.textContent === currentLetter && cell.classList.contains('selected')).length;
        const totalCorrect = [...currentContent].filter(c => c === currentLetter).length;
        dataRecords.push({
          letter: currentLetter,
          correctClicked: correct,
          totalCorrect,
          time: Math.min(elapsed, TIME_LIMIT)
        });
      }

      overlay.classList.remove('hidden');
      let countdown = 3;
      overlay.textContent = `Next page in ${countdown} seconds...`;
      const interval = setInterval(() => {
        countdown--;
        overlay.textContent = `Next page in ${countdown} seconds...`;
        if (countdown === 0) {
          clearInterval(interval);
          overlay.classList.add('hidden');

          currentLetter = getRandomLetter();
          usedLetters.add(currentLetter);
          currentContent = generateArticle(currentLetter);

          targetLetterDisplay.textContent = currentLetter;
          renderGrid(currentContent);

          startTime = performance.now() / 1000;
          pageIndex++;

          setTimeout(() => nextPage(), TIME_LIMIT * 1000);
        }
      }, 1000);
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      let csv = 'Letter,CorrectClicked,TotalCorrect,Time\n';
      dataRecords.forEach(row => {
        csv += `${row.letter},${row.correctClicked},${row.totalCorrect},${row.time}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results.csv';
      a.click();
    });

    nextPage();
  </script>
</body>
</html>

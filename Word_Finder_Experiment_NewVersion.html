<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letter Finder Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #fff;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1vh;
    }
    .title {
      font-size: 1.4em;
      margin-bottom: 0.5vh;
    }
    .letter-block {
      display: grid;
      grid-template-columns: repeat(1, auto);
      text-align: center;
    }
    .letter-line {
      font-size: calc(100vw / 52);
      letter-spacing: 0.25em;
      line-height: 1.5em;
      font-weight: bold;
      white-space: nowrap;
      user-select: none;
    }
    .correct { background-color: lightgreen; }
    .wrong { background-color: lightcoral; }
    button {
      margin-top: 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title" id="title">Loading...</div>
    <div class="letter-block" id="letterBlock"></div>
    <button id="downloadBtn" style="display:none;" onclick="downloadCSV()">Download CSV</button>
  </div>

  <script>
    const CHARSET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789";
    const LINE_LEN = 40;
    const LINES = 25;
    const TOTAL = LINE_LEN * LINES;
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    // 固定假文章對應每個字母（長度 1125）
    const articles = { };
    letters.forEach(letter => {
      let content = "";
      for (let i = 0; i < TOTAL; i++) {
        content += CHARSET[Math.floor(Math.random() * CHARSET.length)];
      }
      articles[letter] = content;
    });

    const order = [...letters].sort(() => Math.random() - 0.5);
    let current = 0;
    let totalLog = [];

    function injectTargets(text, target, count) {
      let arr = text.split("");
      let inserted = 0;
      while (inserted < count) {
        let idx = Math.floor(Math.random() * arr.length);
        if (arr[idx] !== target) {
          arr[idx] = target;
          inserted++;
        }
      }
      return arr.join("");
    }

    function render(letter) {
      const raw = articles[letter];
      const count = Math.floor(Math.random() * 9) + 8; // 8~16
      const modified = injectTargets(raw, letter, count);
      const lines = modified.match(/.{1,45}/g);
      const block = document.getElementById("letterBlock");
      block.innerHTML = "";
      document.getElementById("title").textContent = "Find the letter: " + letter;
      const startTime = Date.now();
      let correct = 0, total = 0, log = [];

      lines.forEach((line, i) => {
        const div = document.createElement("div");
        div.className = "letter-line";
        [...line].forEach((char, j) => {
          const span = document.createElement("span");
          span.textContent = char;
          span.style.cursor = "pointer";
          span.onclick = function() {
            if (span.classList.contains("correct") || span.classList.contains("wrong")) return;
            total++;
            const t = Date.now() - startTime;
            if (char === letter) {
              span.classList.add("correct");
              correct++;
              log.push({letter: letter, char: char, correct: true, time: t});
            } else {
              span.classList.add("wrong");
              log.push({letter: letter, char: char, correct: false, time: t});
            }
          };
          div.appendChild(span);
        });
        block.appendChild(div);
      });

      setTimeout(() => {
        totalLog.push({target: letter, correct, total, log});
        current++;
        if (current < order.length) {
          render(order[current]);
        } else {
          document.getElementById("title").textContent = "✅ Game finished!";
          document.getElementById("letterBlock").innerHTML = "Press the button below to download CSV.";
          document.getElementById("downloadBtn").style.display = "block";
        }
      }, 90000);
    }

    function downloadCSV() {
      let csv = "Target,Char,Correct,Time(ms)\n";
      totalLog.forEach(entry => {
        entry.log.forEach(l => {
          csv += `${entry.target},${l.char},${l.correct},${l.time}\n`;
        });
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "results.csv";
      a.click();
    }

    render(order[current]);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find the Letter Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: 'Times New Roman', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      font-size: 1.8em;
      margin: 1vh 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(45, 1fr);
      gap: 0.5vh;
      padding: 1vh;
      max-width: 95vw;
      font-size: 1.5vw;
      line-height: 1.6;
      text-align: center;
      word-break: break-word;
    }
    .cell {
      cursor: pointer;
      padding: 0.2em;
      user-select: none;
    }
    .marked {
      background-color: yellow;
    }
    #nextOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      display: none;
    }
    #exportBtn {
      margin-top: 20px;
      padding: 8px 16px;
      border: 1px solid black;
      background: white;
      display: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">üîç Find the letter: <span id="targetLetter"></span></div>
  <div id="grid" class="grid"></div>
  <div id="nextOverlay">Next page in 3 seconds...</div>
  <button id="exportBtn" onclick="exportCSV()">Export CSV</button>

  <script>
    const TOTAL_PAGES = 26;
    const ROWS = 25;
    const COLS = 45;
    const MIN_TARGETS = 8;
    const MAX_TARGETS = 16;
    const LETTERS = [...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'];

    let currentPage = 0;
    let results = [];
    let usedLetters = [];
    let startTime = 0;
    let fixedPages = {};

    function generatePage(letter) {
      const totalCells = ROWS * COLS;
      const targetCount = Math.floor(Math.random() * (MAX_TARGETS - MIN_TARGETS + 1)) + MIN_TARGETS;
      const allChars = [...Array(targetCount).fill(letter)];
      while (allChars.length < totalCells) {
        let randChar;
        do {
          randChar = LETTERS[Math.floor(Math.random() * LETTERS.length)];
        } while (randChar === letter);
        allChars.push(randChar);
      }
      for (let i = allChars.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
      }
      fixedPages[letter] = allChars;
    }

    function renderPage() {
      const letter = LETTERS[currentPage];
      if (!fixedPages[letter]) generatePage(letter);
      document.getElementById('targetLetter').innerText = letter;

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      fixedPages[letter].forEach((char, idx) => {
        const span = document.createElement('span');
        span.className = 'cell';
        span.textContent = char;
        span.onclick = () => {
          span.classList.toggle('marked');
        };
        grid.appendChild(span);
      });
      startTime = Date.now();

      setTimeout(endPage, 90000); // 90ÁßíÈôêÂà∂
    }

    function endPage() {
      const marked = document.querySelectorAll('.marked');
      const correct = Array.from(marked).filter(cell => cell.textContent === LETTERS[currentPage]).length;
      results.push({
        letter: LETTERS[currentPage],
        correct: correct,
        time: Math.round((Date.now() - startTime) / 1000)
      });
      currentPage++;
      if (currentPage < TOTAL_PAGES) {
        showOverlay();
      } else {
        showResults();
      }
    }

    function showOverlay() {
      const overlay = document.getElementById('nextOverlay');
      overlay.style.display = 'flex';
      let countdown = 3;
      overlay.textContent = `Next page in ${countdown} seconds...`;
      const interval = setInterval(() => {
        countdown--;
        overlay.textContent = `Next page in ${countdown} seconds...`;
        if (countdown <= 0) {
          clearInterval(interval);
          overlay.style.display = 'none';
          renderPage();
        }
      }, 1000);
    }

    function showResults() {
      document.getElementById('grid').innerHTML = '';
      document.querySelector('.header').innerHTML = '‚úÖ Completed!';
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>Letter</th><th>Correct</th><th>Time (s)</th></tr>';
      results.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${r.letter}</td><td>${r.correct}</td><td>${r.time}</td>`;
        table.appendChild(row);
      });
      document.getElementById('grid').appendChild(table);
      document.getElementById('exportBtn').style.display = 'inline-block';
    }

    function exportCSV() {
      let csv = 'Letter,Correct,Time\n';
      results.forEach(r => {
        csv += `${r.letter},${r.correct},${r.time}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    renderPage();
  </script>
</body>
</html>

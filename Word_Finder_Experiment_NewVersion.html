<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Letter Finder Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: "Times New Roman", serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1vh;
    }
    .title {
      font-size: 1.6em;
      font-weight: bold;
    }
    .letter-block {
      margin-top: 1vh;
    }
    .letter-line {
      font-size: calc(100vw / 52);
      line-height: 1.6em;
      letter-spacing: 0.2em;
      white-space: pre;
      text-align: center;
      font-weight: bold;
      user-select: none;
    }
    .correct { background-color: lightgreen; }
    .wrong { background-color: lightcoral; }
    #timer { margin-top: 0.5em; font-weight: bold; }
    #result, #downloadBtn { margin-top: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title" id="title">üîç Find the letter: </div>
    <div id="timer"></div>
    <div class="letter-block" id="letterBlock"></div>
    <div id="result"></div>
    <button id="downloadBtn" style="display:none;">Download CSV</button>
  </div>

  <script>
    const CHARSET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789";
    const LINE_LEN = 40;
    const LINES = 25;
    const TOTAL = LINE_LEN * LINES;

    // Generate fixed 26 articles (each with a target letter)
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
    let distribution = {};
    let total = 0;
    letters.forEach(l => {
      distribution[l] = Math.floor(Math.random() * 9) + 8;
      total += distribution[l];
    });

    // Adjust to make total 400
    const adjust = 400 - total;
    const keys = letters.slice();
    while (total !== 400) {
      const k = keys[Math.floor(Math.random() * keys.length)];
      if ((adjust > 0 && distribution[k] < 16) || (adjust < 0 && distribution[k] > 8)) {
        distribution[k] += adjust > 0 ? 1 : -1;
        total += adjust > 0 ? 1 : -1;
      }
    }

    const articles = {};
    letters.forEach(letter => {
      let chars = [];
      for (let i = 0; i < TOTAL - distribution[letter]; i++) {
        chars.push(CHARSET[Math.floor(Math.random() * CHARSET.length)]);
      }
      for (let i = 0; i < distribution[letter]; i++) {
        chars.push(letter);
      }
      chars = chars.sort(() => Math.random() - 0.5);
      articles[letter] = chars.join('');
    });

    const order = [...letters].sort(() => Math.random() - 0.5);
    let current = -1;
    let data = [];
    let timer = 90;
    let interval;

    const title = document.getElementById("title");
    const timerEl = document.getElementById("timer");
    const block = document.getElementById("letterBlock");
    const resultEl = document.getElementById("result");
    const downloadBtn = document.getElementById("downloadBtn");

    function render(letter) {
      block.innerHTML = '';
      const text = articles[letter];
      const lines = text.match(/.{1,45}/g);
      const startTime = Date.now();

      lines.forEach((line, row) => {
        const div = document.createElement("div");
        div.className = "letter-line";
        [...line].forEach((char, col) => {
          const span = document.createElement("span");
          span.textContent = char;
          span.onclick = () => {
            if (span.classList.contains("correct") || span.classList.contains("wrong")) return;
            const correct = char === letter;
            span.classList.add(correct ? "correct" : "wrong");
            const t = Math.floor((Date.now() - startTime) / 1000);
            data.push({ page: current + 1, letter, char, correct, time: t });
          };
          div.appendChild(span);
        });
        block.appendChild(div);
      });
    }

    function next() {
      current++;
      if (current >= order.length) {
        showResult();
        return;
      }
      const letter = order[current];
      title.textContent = `üîç Find the letter: ${letter}`;
      render(letter);
      timer = 90;
      timerEl.textContent = `Time: ${timer}s`;
      interval = setInterval(() => {
        timer--;
        timerEl.textContent = `Time: ${timer}s`;
        if (timer <= 0) {
          clearInterval(interval);
          setTimeout(next, 3000);
        }
      }, 1000);
    }

    function showResult() {
      title.textContent = "‚úÖ Game completed!";
      timerEl.textContent = "";
      block.innerHTML = "";
      const perPage = {};
      data.forEach(d => {
        if (!perPage[d.page]) perPage[d.page] = { correct: 0, total: 0 };
        perPage[d.page].total++;
        if (d.correct) perPage[d.page].correct++;
      });
      let html = "<h3>Results</h3><table border='1'><tr><th>Page</th><th>Letter</th><th>Correct</th><th>Total</th><th>Accuracy</th></tr>";
      Object.entries(perPage).forEach(([p, val]) => {
        const acc = ((val.correct / val.total) * 100).toFixed(1);
        html += `<tr><td>${p}</td><td>${order[p - 1]}</td><td>${val.correct}</td><td>${val.total}</td><td>${acc}%</td></tr>`;
      });
      html += "</table>";
      resultEl.innerHTML = html;
      downloadBtn.style.display = "block";
    }

    downloadBtn.onclick = () => {
      let csv = "Page,Letter,Char,Correct,Time\n";
      data.forEach(d => {
        csv += `${d.page},${d.letter},${d.char},${d.correct},${d.time}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "results.csv";
      a.click();
    };

    next();
  </script>
</body>
</html>

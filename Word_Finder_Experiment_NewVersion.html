<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letter Finder</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Times New Roman", serif;
      background: #f2f2f2;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
      text-align: center;
    }
    .letter-grid {
      display: grid;
      grid-template-rows: repeat(25, auto);
      gap: 0.5vh;
      font-size: calc(1.5vw + 0.5vh);
      line-height: 1.8;
      letter-spacing: 0.5ch;
      white-space: pre;
      word-break: break-word;
    }
    .line {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .char {
      margin: 0 0.2ch;
      cursor: pointer;
    }
    .char.correct { background-color: lightgreen; }
    .char.incorrect { background-color: lightcoral; }
    #startBtn, #exportBtn {
      padding: 0.5em 1.2em;
      font-size: 1em;
      margin: 1em;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      font-size: 2em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="overlay" class="hidden">Next page in 3 seconds...</div>
  <div class="container">
    <h2>üîç Find the letter: <span id="targetLetter">A</span></h2>
    <div id="grid" class="letter-grid"></div>
    <button id="exportBtn">Export CSV</button>
  </div>
  <script>
    const TOTAL_PAGES = 26;
    const LINES = 25;
    const CHARS_PER_LINE = 45;
    const TOTAL_TARGETS = 400;
    const MIN_PER_LETTER = 8;
    const MAX_PER_LETTER = 16;
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const DIGITS = "0123456789";
    const ALLCHARS = LETTERS + DIGITS;
    const grid = document.getElementById("grid");
    const targetSpan = document.getElementById("targetLetter");
    const overlay = document.getElementById("overlay");
    let pages = [], order = [], currentPage = 0, timer, timeLeft;
    let results = [];

    function randomChar(exclude) {
      let c;
      do { c = ALLCHARS[Math.floor(Math.random() * ALLCHARS.length)]; }
      while (c === exclude);
      return c;
    }

    function generateArticles() {
      let counts = {}, remaining = TOTAL_TARGETS;
      LETTERS.split('').forEach((l, i) => {
        const left = LETTERS.length - i;
        const minPossible = MIN_PER_LETTER;
        const maxPossible = Math.min(MAX_PER_LETTER, remaining - (left - 1) * MIN_PER_LETTER);
        const count = Math.floor(Math.random() * (maxPossible - minPossible + 1)) + minPossible;
        counts[l] = count;
        remaining -= count;
      });
      for (let l of LETTERS) {
        const count = counts[l];
        let content = [];
        let positions = new Set();
        while (positions.size < count) {
          positions.add(Math.floor(Math.random() * (LINES * CHARS_PER_LINE)));
        }
        for (let i = 0; i < LINES * CHARS_PER_LINE; i++) {
          content.push(positions.has(i) ? l : randomChar(l));
        }
        pages.push({ letter: l, content });
      }
      order = [...Array(TOTAL_PAGES).keys()];
      for (let i = order.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [order[i], order[j]] = [order[j], order[i]];
      }
    }
        line.appendChild(span);
      }
      grid.appendChild(line);
    }
  }

  function nextPage() {
    if (currentPage >= TOTAL_PAGES) {
      exportCSV();
      return;
    }
    showPage(currentPage);
    results[order[currentPage]] = { letter: pages[order[currentPage]].letter, clicks: [], timeStart: Date.now() };
    timeLeft = 90;
    timer = setInterval(() => {
      if (--timeLeft <= 0) {
        clearInterval(timer);
        results[order[currentPage]].timeEnd = Date.now();
        currentPage++;
        if (currentPage < TOTAL_PAGES) {
          overlay.classList.remove("hidden");
          setTimeout(() => {
            overlay.classList.add("hidden");
            nextPage();
          }, 3000);
        } else {
          exportCSV();
        }
      }
    }, 1000);
  }

  function exportCSV() {
    let csv = "Letter,Total Clicks,Correct Clicks,Wrong Clicks,Time (s)\n";
    for (let i = 0; i < TOTAL_PAGES; i++) {
      const r = results[i];
      if (!r) continue;
      const time = Math.round((r.timeEnd - r.timeStart) / 1000);
      const correct = r.clicks.filter(c => c.correct).length;
      const wrong = r.clicks.length - correct;
      csv += `${r.letter},${r.clicks.length},${correct},${wrong},${time}\n`;
    }
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "results.csv";
    a.click();
  }

  document.getElementById("exportBtn").addEventListener("click", exportCSV);
  generateArticles();
  nextPage();
</script>
</body>
</html>

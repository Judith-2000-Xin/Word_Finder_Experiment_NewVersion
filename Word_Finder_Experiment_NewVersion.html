<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Letter Finder Game</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Times New Roman", serif;
      background: #f4f4f4;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    .letter {
      font-size: 1.8em;
      margin-top: 1vh;
    }
    .grid {
      display: grid;
      grid-template-rows: repeat(25, 1fr);
      row-gap: 0.5em;
      line-height: 1.5;
      font-size: calc(1.4vw + 0.4em);
      padding: 1vh;
      max-width: 90vw;
      overflow: hidden;
      white-space: pre;
      word-break: break-word;
    }
    .grid span {
      letter-spacing: 0.5ch;
      cursor: pointer;
    }
    .selected {
      background-color: yellow;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #resultTable {
      margin-top: 2vh;
      border-collapse: collapse;
      width: 80vw;
    }
    #resultTable td, #resultTable th {
      border: 1px solid black;
      padding: 0.5em;
    }
    #exportBtn {
      margin-top: 1em;
      padding: 0.5em 1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="letter" id="targetLetter">üîç Find the letter: </div>
    <div class="grid" id="textGrid"></div>
    <button id="exportBtn" class="hidden">Export CSV</button>
    <div id="result"></div>
  </div>
  <div class="overlay" id="overlay">Next page in 3 seconds...</div>

  <script>
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const totalPages = 26;
    const rows = 25;
    const cols = 45;
    const minTarget = 8;
    const maxTarget = 16;
    const totalTargets = 400;
    const pages = [];
    const results = [];

    function getRandomChar(exclude) {
      let pool = "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789";
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function generatePages() {
      let distribution = {};
      while (Object.keys(distribution).length < 26) {
        let letter = letters[Object.keys(distribution).length];
        distribution[letter] = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;
      }
      let assigned = Object.values(distribution).reduce((a, b) => a + b, 0);
      let diff = totalTargets - assigned;
      while (diff !== 0) {
        for (let l of letters) {
          if (diff === 0) break;
          if (diff > 0 && distribution[l] < maxTarget) {
            distribution[l]++;
            diff--;
          } else if (diff < 0 && distribution[l] > minTarget) {
            distribution[l]--;
            diff++;
          }
        }
      }
      for (let letter of letters) {
        let count = distribution[letter];
        let content = [];
        let allChars = [];
        for (let i = 0; i < rows * cols - count; i++) {
          allChars.push(getRandomChar(letter));
        }
        for (let i = 0; i < count; i++) {
          allChars.splice(Math.floor(Math.random() * allChars.length), 0, letter);
        }
        for (let i = 0; i < rows; i++) {
          content.push(allChars.slice(i * cols, (i + 1) * cols));
        }
        pages.push({ letter, content });
      }
    }

    function shufflePages() {
      for (let i = pages.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pages[i], pages[j]] = [pages[j], pages[i]];
      }
    }

    let currentPage = 0;
    let correct = 0;
    let startTime;

    function renderPage() {
      const { letter, content } = pages[currentPage];
      document.getElementById("targetLetter").innerText = `üîç Find the letter: ${letter}`;
      const grid = document.getElementById("textGrid");
      grid.innerHTML = "";
      content.forEach(line => {
        const row = document.createElement("div");
        line.forEach(char => {
          const span = document.createElement("span");
          span.innerText = char;
          span.addEventListener("click", () => {
            span.classList.toggle("selected");
          });
          row.appendChild(span);
        });
        grid.appendChild(row);
      });
      startTime = Date.now();
    }

    function nextPage() {
      const spans = document.querySelectorAll(".grid span");
      const found = Array.from(spans).filter(s => s.classList.contains("selected")).filter(s => s.innerText === pages[currentPage].letter).length;
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      results.push({ page: currentPage + 1, letter: pages[currentPage].letter, correct: found, time: timeSpent });

      currentPage++;
      if (currentPage >= totalPages) {
        showResults();
      } else {
        document.getElementById("overlay").style.display = "flex";
        setTimeout(() => {
          document.getElementById("overlay").style.display = "none";
          renderPage();
        }, 3000);
      }
    }

    function showResults() {
      const result = document.getElementById("result");
      const table = document.createElement("table");
      table.id = "resultTable";
      const header = table.insertRow();
      ["Page", "Letter", "Correct Clicks", "Time (s)"].forEach(h => header.insertCell().innerText = h);
      results.forEach(r => {
        const row = table.insertRow();
        row.insertCell().innerText = r.page;
        row.insertCell().innerText = r.letter;
        row.insertCell().innerText = r.correct;
        row.insertCell().innerText = r.time;
      });
      result.appendChild(table);
      document.getElementById("exportBtn").classList.remove("hidden");
    }

    document.getElementById("exportBtn").addEventListener("click", () => {
      let csv = "Page,Letter,Correct,Time\n" + results.map(r => `${r.page},${r.letter},${r.correct},${r.time}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "results.csv";
      a.click();
    });

    document.addEventListener("DOMContentLoaded", () => {
      generatePages();
      shufflePages();
      document.getElementById("overlay").style.display = "none";
      renderPage();
      setInterval(() => {
        if (currentPage < totalPages && document.getElementById("overlay").style.display === "none") {
          nextPage();
        }
      }, 90000); // 90ÁßíÊèõÈ†Å
    });
  </script>
</body>
</html>
